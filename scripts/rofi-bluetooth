#!/usr/bin/env bash

# Rofi Bluetooth Manager
# Simple script to manage Bluetooth via Rofi

# Check if Bluetooth is powered on
check_bluetooth_status() {
    if bluetoothctl show | grep -q "Powered: yes"; then
        echo "on"
    else
        echo "off"
    fi
}

# Power on Bluetooth
power_on() {
    bluetoothctl power on > /dev/null 2>&1
}

# Power off Bluetooth
power_off() {
    bluetoothctl power off > /dev/null 2>&1
}

# Scan for devices
scan_devices() {
    # Start scanning
    bluetoothctl scan on > /dev/null 2>&1 &
    local scan_pid=$!

    # Wait a few seconds for devices to be discovered
    sleep 5

    # Stop scanning
    bluetoothctl scan off > /dev/null 2>&1
    kill $scan_pid 2>/dev/null

    notify-send "Bluetooth" "Scan completed"
}

# Connect to a device
connect_to_device() {
    # Get list of devices
    local devices=$(bluetoothctl devices | awk '{print $2 " " substr($0, index($0,$3))}')

    if [ -z "$devices" ]; then
        notify-send "Bluetooth" "No devices found"
        return
    fi

    # Show devices in Rofi
    local chosen=$(echo "$devices" | rofi -dmenu -p "Select device to connect" -theme custom)

    if [ -n "$chosen" ]; then
        # Extract MAC address (first word)
        local mac=$(echo "$chosen" | awk '{print $1}')
        local name=$(echo "$chosen" | cut -d' ' -f2-)

        # Connect to device
        if bluetoothctl connect "$mac" 2>&1 | grep -q "successful"; then
            notify-send "Bluetooth" "Connected to $name"
        else
            notify-send "Bluetooth" "Failed to connect to $name"
        fi
    fi
}

# Main menu
main() {
    local status=$(check_bluetooth_status)

    # Build menu options based on current status
    local options=""
    if [ "$status" = "on" ]; then
        options="Scan\nConnect\nPower OFF\nRefresh"
    else
        options="Power ON\nRefresh"
    fi

    # Show Rofi menu
    local chosen=$(echo -e "$options" | rofi -dmenu -p "Bluetooth [$status]" -theme custom)

    # Handle selection
    case "$chosen" in
        "Power ON")
            power_on
            ;;
        "Power OFF")
            power_off
            ;;
        "Scan")
            scan_devices
            ;;
        "Connect")
            connect_to_device
            ;;
        "Refresh")
            main
            ;;
    esac
}

main
